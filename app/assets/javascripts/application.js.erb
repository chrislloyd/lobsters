//= require rails-ujs
//= require jquery
//= require jquery_ujs
//= require_tree .

"use strict";

// Polyfill Element.matches()
// https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#polyfill
if (!Element.prototype.matches) {
  Element.prototype.matches = Element.prototype.msMatchesSelector || 
                              Element.prototype.webkitMatchesSelector;
}

// Polyfill Element.closest()
// https://developer.mozilla.org/en-US/docs/Web/API/Element/closest#polyfill
if (!Element.prototype.closest) {
  Element.prototype.closest = function(s) {
    var el = this;
    if (!document.documentElement.contains(el)) return null;
    do {
      if (el.matches(s)) return el;
      el = el.parentElement || el.parentNode;
    } while (el !== null && el.nodeType === 1);
    return null;
  };
}

// Parameter encodes an object to replicate jQuery.post's behavior for it's
// second argument.
function param(object) {
  var encodedString = '';
  for (var prop in object) {
    if (object.hasOwnProperty(prop) && object[prop] != undefined) {
      if (encodedString.length > 0) {
        encodedString += '&';
      }
      encodedString += encodeURI(prop + '=' + object[prop]);
    }
  }
  return encodedString;
}

function removeEl(el) {
  return el.parentNode.removeChild(el);
}

function replaceEl(oldEl, newEl) {
  return oldEl.parentNode.replaceChild(newEl, oldEl);
}

var _Lobsters = Class.extend({
  curUser: null,

  storyFlagReasons: { <%= Vote::STORY_REASONS.map{|k,v|
      "#{k.inspect}: #{v.inspect}" }.join(", ") %> },
  commentDownvoteReasons: { <%= Vote::COMMENT_REASONS.map{|k,v|
      "#{k.inspect}: #{v.inspect}" }.join(", ") %> },

  upvoteStory: function(voterEl) {
    Lobsters.vote("story", voterEl, 1);
  },
  flagStory: function(voterEl) {
    Lobsters._showDownvoteWhyAt("story", voterEl, function(k) {
      Lobsters.vote("story", voterEl, -1, k); });
  },
  hideStory: function(hiderEl) {
    if (!Lobsters.curUser)
      return Lobsters.bounceToLogin();

    var li = hiderEl.closest(".story, .comment");
    var act;

    if (li.classList.contains("hidden")) {
      act = "unhide";
      li.classList.remove("hidden");
      hiderEl.innerHTML = "hide";
    } else {
      act = "hide";
      li.classList.add("hidden");
      hiderEl.innerHTML = "unhide";
    }

    Rails.ajax({
      type: "POST",
      url: "/stories/" + li.getAttribute("data-shortid") + "/" + act,
    });
  },
  saveStory: function(saverEl) {
    if (!Lobsters.curUser)
      return Lobsters.bounceToLogin();

    var li = saverEl.closest(".story, .comment");
    var act;

    if (li.classList.contains("saved")) {
      act = "unsave";
      li.classList.remove("saved");
      saverEl.innerHTML = "save";
    } else {
      act = "save";
      li.classList.add("saved");
      saverEl.innerHTML = "unsave";
    }

    Rails.ajax({
      type: "POST",
      url: "/stories/" + li.getAttribute("data-shortid") + "/" + act,
    });
  },

  upvoteComment: function(voterEl) {
    Lobsters.vote("comment", voterEl, 1);
  },
  downvoteComment: function(voterEl) {
    Lobsters._showDownvoteWhyAt("comment", voterEl, function(k) {
      Lobsters.vote("comment", voterEl, -1, k); });
  },
  _showDownvoteWhyAt: function(thingType, voterEl, onChooseWhy) {
    if (!Lobsters.curUser)
      return Lobsters.bounceToLogin();

    var li = voterEl.closest(".story, .comment");
    if (li.classList.contains("downvoted")) {
      /* already upvoted, neutralize */
      Lobsters.vote(thingType, voterEl, -1, null);
      return;
    }

    if (document.getElementById("downvote_why")) {
      removeEl(document.getElementById("downvote_why"));
    }
    if (document.getElementById("downvote_why_shadow")) {
      removeEl(document.getElementById("downvote_why_shadow"));
    }

    var sh = document.createElement("div");
    sh.id = "downvote_why_shadow";
    voterEl.insertAdjacentElement("afterend", sh);

    sh.addEventListener('click', function() {
      removeEl(document.getElementById("downvote_why_shadow"));
      removeEl(document.getElementById("downvote_why"));
    });

    var d = document.createElement("div");
    d.id = "downvote_why";

    var reasons;
    if (thingType === "comment") {
      reasons = Lobsters.commentDownvoteReasons;
    } else {
      reasons = Lobsters.storyFlagReasons;
    }

    Object.keys(reasons).forEach(function(k) {
      var v = reasons[k];
      var a = document.createElement("a");
      a.setAttribute("href", "#");
      a.textContent = v;
      if (k === "") {
        a.classList.add("cancelreason");
      }

      a.addEventListener("click", function(e) {
        removeEl(document.getElementById("downvote_why"));
        removeEl(document.getElementById("downvote_why_shadow"));

        if (k != "") {
          onChooseWhy(k);
        }

        e.preventDefault();
      });

      d.appendChild(a);
    });

    if (thingType === "story") {
      d.style.top = voterEl.offsetTop + voterEl.offsetHeight - 2 + "px";
      d.style.left = voterEl.offsetLeft - 2 + "px";
      voterEl.closest("li").insertAdjacentElement('afterend', d);
    } else {
      // place downvote menu outside of the comment to avoid inheriting opacity
      var voterPosLeft = voterEl.offsetLeft;
      var voterPosTop = voterEl.offsetTop;
      voterEl.closest(".comments_subtree").appendChild(d);
      d.style.left = voterPosLeft;
      d.style.top = voterPosTop + voterEl.offsetHeight;
    }
  },

  vote: function(thingType, voterEl, point, reason) {
    if (!Lobsters.curUser)
      return Lobsters.bounceToLogin();

    var li = voterEl.closest(".story, .comment");
    var scoreDiv = li.querySelector("div.score");
    var showScore = true;
    var score = parseInt(scoreDiv.innerHTML);
    if (isNaN(score)) {
      showScore = false;
      score = 0;
    }
    var action = "";

    if (li.classList.contains("upvoted") && point > 0) {
      /* already upvoted, neutralize */
      li.classList.remove("upvoted");
      score--;
      action = "unvote";
    } else if (li.classList.contains("downvoted") && point < 0) {
      /* already downvoted, neutralize */
      li.classList.remove("downvoted");
      score++;
      action = "unvote";
    } else if (point > 0) {
      if (li.classList.contains("downvoted")) {
        /* flip flop */
        score++;
      }

      li.classList.remove("downvoted");
      li.classList.add("upvoted");
      score++;
      action = "upvote";
    } else if (point < 0) {
      if (li.classList.contains("upvoted"))
        /* flip flop */
        score--;

      li.classList.remove("upvoted");
      li.classList.add("downvoted");
      score--;
      action = "downvote";
    }

    if (showScore) {
      scoreDiv.innerHTML = score;
    }

    if (action == "upvote" || action == "unvote") {
      var reasonEl = li.querySelector(".reason");
      if (reasonEl) {
        reasonEl.innerHTML = "";
      }

      if (action == "unvote" && thingType == "story" && point < 0) {
        li.querySelector(".flagger").innerText = 'flag';
      }
    } else if (action == "downvote" && thingType == "comment") {
      li.querySelector(".reason").innerHTML = "| " +
        Lobsters.commentDownvoteReasons[reason].toLowerCase();
    } else if (action == "downvote" && thingType == "story") {
      li.querySelector(".flagger").innerText = "unflag";
    }

    Rails.ajax({
      type: "POST",
      url: (
        "/" + (thingType == "story" ? "stories" : thingType + "s") + "/" +
        li.getAttribute("data-shortid") + "/" +
        action
      ),
      data: param({ reason: reason }),
    })
  },

  postComment: function(form) {
    var params = $(form).serializeArray();
    params.push({"name": "show_tree_lines", "value": "true"});

    $.post($(form).attr("action"), params, function(data) {
      var parsedHTML = $.parseHTML(data);

      var isEdit = $(form).hasClass("edit_comment");
      var hasChildren = $(form).closest(".comments_subtree")
        .find(".comments_subtree").length;
      if (isEdit && hasChildren) {
        $(parsedHTML).find(".comment_parent_tree_line:first")
          .removeClass("no_children");
      }

      if ($(form).find("#parent_comment_short_id").length) {
        // reply to comment
        $(form).closest(".comments_subtree")
          .find(".comment_parent_tree_line:first").removeClass("no_children");
        $(form).closest(".comment").replaceWith(parsedHTML);
      } else {
        // reply to story
        $(form).parent(".comment").replaceWith(parsedHTML);
      }
    });
  },

  previewComment: function(form) {
    var data = Rails.serializeElement(form, param({
      preview: true,
      show_tree_lines: true
    }));
    Rails.ajax({
      type: "POST",
      url: form.getAttribute("action"),
      data: data,
      success: function(da) {
        var ta = da.querySelector("textarea");
        replaceEl(form.closest(".comment"), da.body.children[0]);
        autosize(ta);
      },
    });
  },

  previewStory: function(form) {
    $("#inside").load("/stories/preview", $(form).serializeArray(),
    function() {
      Lobsters.runSelect2();
    });
  },

  checkStoryDuplicate: function(form) {
    var params = $(form).serializeArray();
    $.post("/stories/check_url_dupe", params, function(formErrorsHtml) {
      $(form).find(".form_errors_header").html(formErrorsHtml);
    });
  },

  checkStoryTitle: function() {
    var title = $("#story_title").val();
    if (title === undefined) {
      return;
    }
    var m;
    if (m = title.match(/^(show|ask) lobste\.?rs:? (.+)$/i)) {
      var ta = $("#story_tags_a").data("select2");
      if (ta.getVal().indexOf(m[1].toLowerCase()) < 0)
        ta.addSelectedChoice({ id: m[1].toLowerCase() });
      $("#story_title").val(m[2]);
    }

    // common separators or (parens) that don't enclose a 4-digit year
    if (title.match(/: | - | – | — | \| | · | • | by /) ||
        title.match(/\([^\)]*\)/g).some(function (p) { return !p.match(/\(\d{4}\)/) })
    ) {
      $('.title-reminder').slideDown();
    }
  },

  runSelect2: function() {
    $("#story_tags_a").select2({
    formatSelection: function(what) {
      return what.id;
    },
    matcher: function(term, text) {
      return text.toUpperCase().indexOf(term.toUpperCase()) >= 0;
    },
    sortResults: function(results, container, query) {
        if (query.term) {
          var tmatches = [];
          var dmatches = [];

          /* prefer tag matches first, then description matches */
          for (var x in results) {
            var r = results[x];

            if (r.id.toUpperCase().indexOf(query.term.toUpperCase()) == 0)
              tmatches.push(r);
            else
              dmatches.push(r);
          }

          tmatches = tmatches.sort(function(a, b) {
            return a.text.localeCompare(b.text);
          });
          dmatches = dmatches.sort(function(a, b) {
            return a.text.localeCompare(b.text);
          });

          return tmatches.concat(dmatches);
        }

        return results;
    }
    });
  },

  moderateStory: function(link) {
    var reason = $("#story_moderation_reason").val();
    if (reason == null || reason == "")
      return false;

    var link = $(link);

    /* $.rails.handleMethod() */
    var href = $.rails.href(link),
      method = link.data('method'),
      target = link.attr('target'),
      csrf_token = $("meta[name=csrf-token]").attr("content"),
      csrf_param = $("meta[name=csrf-param]").attr("content"),
      form = $("<form method=\"post\" action=\"" + href + "\"></form>"),
      metadata_input = "<input name=\"_method\" value=\"" + method +
        "\" type=\"hidden\" />";

    if (csrf_param !== undefined && csrf_token !== undefined)
      metadata_input += "<input name=\"" + csrf_param + "\" value=\"" +
        csrf_token + "\" type=\"hidden\" />";

    if (target)
      form.attr("target", target);

    var r = $("<input type=\"hidden\" name=\"reason\" />");
    r.val(reason);
    form.append(r);

    form.hide().append(metadata_input).appendTo('body');
    form.submit();

    return false;
  },

  fetchURLTitle: function(button, url_field, title_field) {
    if (url_field.val() == "")
      return;

    var old_value = button.val();
    button.prop("disabled", true);
    button.val("Fetching...");

    $.post("/stories/fetch_url_attributes", {
      fetch_url: url_field.val(),
    })
    .success(function(data) {
      if (data) {
        if (data.title)
          title_field.val(data.title.substr(0, title_field.maxLength));
        if (data.url)
          url_field.val(data.url);
      }

      button.val(old_value);
      button.prop("disabled", false);
    })
    .error(function() {
      button.val(old_value);
      button.prop("disabled", false);
    });
  },

  bounceToLogin: function() {
    document.location = "/login?return=" +
      encodeURIComponent(document.location);
    return false;
  },
});

var Lobsters = new _Lobsters();

$(document).ready(function() {
  var $olcomments = $("ol.comments");
  $olcomments.on("click", ".comment a.downvoter", function() {
    Lobsters.downvoteComment(this);
    return false;
  });
  $olcomments.on("click", ".comment a.upvoter", function() {
    Lobsters.upvoteComment(this);
    return false;
  });

  $("li.story a.flagger").click(function() {
    Lobsters.flagStory(this);
    return false;
  });
  $("li.story a.upvoter").click(function() {
    Lobsters.upvoteStory(this);
    return false;
  });
  $("li.story a.hider").click(function() {
    Lobsters.hideStory(this);
    return false;
  });
  $("li.story a.saver").click(function() {
    Lobsters.saveStory(this);
    return false;
  });

  $("a.mod_story_link").click(function() {
    return Lobsters.moderateStory(this);
  }),

  $("select[name=message\\[hat_id\\]]").change(function() {
    $(this).siblings("input[name=message\\[mod_note\\]]")
      .prop("checked", !!$(this).find('option:selected').data('modnote'));
  }),

  $(document).on("click", "a.comment_replier", function() {
    if (!Lobsters.curUser) {
      Lobsters.bounceToLogin();
      return false;
    }

    var comment = $(this).closest(".comment");
    if ($("#reply_form_" + comment.attr("id")).length > 0)
      return false;

    var sel = "";
    if (window.getSelection)
      sel = window.getSelection().toString();
    else if (document.selection && document.selection.type != "Control")
      sel = document.selection.createRange().text;

    if (sel != "") {
      var t = "";
      $.each(sel.split("\n"), function(k, v) {
        t += (t == "" ? "" : "\n") + "> " + v;
      });
      sel = t;

      if (sel != "")
        sel += "\n\n";
    }

    var replies = comment.nextAll(".comments").first();
    $.get("/comments/" + comment.attr("data-shortid") + "/reply",
    function(data) {
      var reply = $($.parseHTML(data));
      reply.attr("id", "reply_form_" + comment.attr("id"));
      replies.prepend(reply);
      var ta = reply.find("textarea");
      ta.focus().text(sel);
      autosize(ta);
    });

    return false;
  });

  $(document).on("click", "button.comment-cancel", function() {
    var comment = $(this).closest(".comment");
    var comment_id = comment.attr("data-shortid");
    if (comment_id != null && comment_id !== '') {
      $.get("/comments/" + comment_id + "?show_tree_lines=true",
        function(data) {
          var parsedHTML = $.parseHTML(data);
          var isEdit = comment.children("form").hasClass("edit_comment");
          var hasChildren = comment.closest(".comments_subtree")
            .find(".comments_subtree").length;
          if (isEdit && hasChildren) {
            $(parsedHTML).find(".comment_parent_tree_line:first")
              .removeClass("no_children");
          }
          comment.replaceWith(parsedHTML);
        });
    } else {
      comment.remove();
    }
  });

  $(document).on("click", "a.comment_editor", function() {
    var comment = $(this).closest(".comment");
    $.get("/comments/" + comment.attr("data-shortid") + "/edit",
    function(data) {
      comment.replaceWith($.parseHTML(data));
    });
  });

  $(document).on("click", "a.comment_deletor", function() {
    if (confirm("Are you sure you want to delete this comment?")) {
      var li = $(this).closest(".comment");
      $.post("/comments/" + $(li).attr("data-shortid") + "/delete",
      function(d) {
        $(li).replaceWith(d);
      });
    }
  });
  $(document).on("click", "a.comment_undeletor", function() {
    if (confirm("Are you sure you want to undelete this comment?")) {
      var li = $(this).closest(".comment");
      $.post("/comments/" + $(li).attr("data-shortid") + "/undelete",
      function(d) {
        $(li).replaceWith(d);
      });
    }
  });

  $(document).on("click", "a.comment_disownor", function() {
    if (confirm("Are you sure you want to disown this comment?")) {
      var li = $(this).closest(".comment");
      $.post("/comments/" + $(li).attr("data-shortid") + "/disown",
      function(d) {
        $(li).replaceWith(d);
      });
    }
  });

  $(document).on("click", "a.comment_moderator", function() {
    var reason = prompt("Moderation reason:");
    if (reason == null || reason == "")
      return false;

    var li = $(this).closest(".comment");
    $.post("/comments/" + $(li).attr("data-shortid") + "/delete",
      { reason: reason }, function(d) {
        $(li).replaceWith(d);
      });
  });

  Lobsters.runSelect2();

  $(document).on("click", "div.markdown_help_toggler .markdown_help_label",
  function() {
    $(this).parents("div.markdown_help_toggler").first().
      children(".markdown_help").toggle();
  });

  $(document).on("click", ".comment-post", function(event) {
    event.preventDefault();
    Lobsters.postComment($(this).parents("form").first());
  });

  $(document).on("click", "button.comment-preview", function() {
    Lobsters.previewComment($(this).parents("form").first()[0]);
  });

  $(document).on("click", "button.story-preview", function() {
    Lobsters.previewStory($(this).parents("form").first());
  });

  $(document).on("blur", "#story_url", function() {
    var url_tags = {
      "\.pdf$": "pdf",
      "[\/\.]((youtube|vimeo)\.com|youtu\.be|twitch.tv)\/": "video",
      "[\/\.](slideshare\.net|speakerdeck\.com)\/": "slides",
      "[\/\.](soundcloud\.com)\/": "audio",
    };

    for (var u in url_tags) {
      var tag = url_tags[u];

      if ($("#story_url").val().match(new RegExp(u, "i"))) {
        var ta = $("#story_tags_a").data("select2");
        if (ta.getVal().indexOf(tag) < 0)
          ta.addSelectedChoice({ id: tag });
      }
    }

    if ($("#story_url").val().length > 0) {
      Lobsters.checkStoryDuplicate($(this).parents("form").first());
    }
  });

  $(document).on("blur change", "#story_title", Lobsters.checkStoryTitle);
  $(document).ready(Lobsters.checkStoryTitle);

  $(document).on("click", "#story_guidelines_toggler", function() {
    $("#story_guidelines").toggle();
    return false;
  });


  $('textarea#comment').keydown(function (e) {
    if ((e.metaKey || e.ctrlKey) && e.keyCode == 13) {
      $(".comment-post").click();
    }
  });
});

